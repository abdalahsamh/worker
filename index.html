<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام حساب يومية العامل</title>
    <style>
      :root {
        --bg-1: #f5f7fa;
        --bg-2: #c3cfe2;
        --card-bg: #ffffff;
        --muted: #7f8c8d;
        --accent-green: #2ecc71;
        --accent-orange: #f39c12;
        --accent-red: #e74c3c;
        --text: #333;
        --max-width: 980px;
        --gap: 16px;
      }

      /* Reset-ish */
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 20px;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 100%);
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        max-width: var(--max-width);
        margin: 0 auto;
        background: var(--card-bg);
        padding: 24px;
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }

      h1 {
        margin: 0 0 18px 0;
        text-align: center;
        color: #2c3e50;
        font-size: 1.6rem;
        padding-bottom: 12px;
        border-bottom: 2px solid #eee;
      }

      .balance-container {
        background: linear-gradient(to right, #16a085, #1abc9c);
        color: #fff;
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 18px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .balance-container div {
        line-height: 1.2;
      }
      .balance {
        font-size: 1.6rem;
        font-weight: 700;
        margin-top: 6px;
      }

      .top-row {
        display: flex;
        gap: var(--gap);
        align-items: stretch;
        margin-bottom: 18px;
      }

      .buttons-container {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 20px;
        border-radius: 10px;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        transition: transform 0.18s ease, box-shadow 0.18s ease,
          opacity 0.12s ease;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .attendance {
        background: linear-gradient(to right, #27ae60, #2ecc71);
        color: #fff;
      }
      .overtime {
        background: linear-gradient(to right, #e67e22, #f39c12);
        color: #fff;
      }
      .delete {
        background: linear-gradient(to right, #e74c3c, #c0392b);
        color: #fff;
        padding: 10px 16px;
        font-size: 0.95rem;
      }

      /* Filters */
      .filters {
        margin-left: auto;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      select {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1.5px solid #e6e6e6;
        background: white;
        font-size: 0.95rem;
        min-width: 120px;
      }

      /* History area */
      .history {
        margin-top: 6px;
      }
      .history-header {
        display: flex;
        gap: 12px;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
      .history-header h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #2c3e50;
      }

      /* Table wrapper for horizontal scroll on smaller devices */
      .table-wrap {
        width: 100%;
        overflow: auto;
        border-radius: 8px;
        border: 1px solid #f0f0f0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px; /* allows horizontal scroll on small screens */
      }
      th,
      td {
        padding: 12px 14px;
        text-align: center;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.95rem;
      }
      th {
        background: #34495e;
        color: #fff;
        font-weight: 600;
      }
      tr:hover td {
        background: #fbfbfb;
      }

      .no-records {
        text-align: center;
        padding: 20px;
        color: var(--muted);
      }

      .delete-btn {
        background: var(--accent-red);
        color: #fff;
        border: none;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      /* Modals */
      .input-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .input-modal.open {
        display: flex;
      }

      .modal-content {
        width: 420px;
        max-width: 95%;
        background: #fff;
        border-radius: 12px;
        padding: 22px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.18);
        transform: translateY(-18px);
        opacity: 0;
        transition: transform 0.24s ease, opacity 0.24s ease;
      }
      .input-modal.open .modal-content {
        transform: none;
        opacity: 1;
      }

      .modal-title {
        margin: 0 0 12px 0;
        font-size: 1.05rem;
        color: #2c3e50;
      }
      .amount-input {
        width: 100%;
        padding: 12px;
        font-size: 1.05rem;
        border-radius: 8px;
        border: 1.5px solid #e6e6e6;
        text-align: center;
      }
      .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }
      .modal-btn {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        border: none;
        font-size: 0.95rem;
      }
      .confirm-btn {
        background: var(--accent-green);
        color: #fff;
      }
      .cancel-btn {
        background: var(--accent-red);
        color: #fff;
      }

      /* Responsive cards for very small screens: convert table rows to cards */
      @media (max-width: 700px) {
        .top-row {
          flex-direction: column;
          gap: 12px;
        }
        .filters {
          margin-left: 0;
          justify-content: flex-start;
        }
        .buttons-container .btn {
          min-width: 0;
          width: 100%;
          padding: 14px;
          font-size: 1.05rem;
          border-radius: 10px;
        }

        /* transform table to card-like list */
        table {
          min-width: unset;
          border: none;
        }
        thead {
          display: none;
        }
        tbody {
          display: block;
        }
        tr {
          display: block;
          background: #fff;
          border: 1px solid #f0f0f0;
          margin-bottom: 12px;
          padding: 10px;
          border-radius: 10px;
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.03);
        }
        td {
          display: flex;
          justify-content: space-between;
          padding: 8px 6px;
          border-bottom: none;
        }
        td[data-label]::before {
          content: attr(data-label);
          display: block;
          font-weight: 600;
          color: #555;
          margin-left: 8px;
        }
        .delete-btn {
          align-self: center;
        }
        .balance {
          font-size: 1.35rem;
        }
      }

      /* smaller tweaks */
      @media (max-width: 420px) {
        .modal-content {
          padding: 18px;
        }
        .modal-title {
          font-size: 1rem;
        }
        th,
        td {
          padding: 10px 8px;
          font-size: 0.92rem;
        }
        select {
          min-width: 100px;
        }
      }

      /* focus styles for accessibility */
      button:focus,
      select:focus,
      input:focus {
        outline: 3px solid rgba(52, 152, 219, 0.15);
        outline-offset: 2px;
      }
    </style>
  </head>

  <body>
    <div class="container" role="main">
      <h1>نظام حساب يومية العامل</h1>

      <div class="balance-container" aria-live="polite">
        <div>الرصيد الحالي</div>
        <div class="balance"><span id="totalBalance">0</span> جنيه</div>
      </div>

      <div class="top-row">
        <div
          class="buttons-container"
          role="toolbar"
          aria-label="أزرار العمليات"
        >
          <button
            class="btn attendance"
            onclick="showInputModal('حضور')"
            aria-label="تسجيل حضور"
          >
            حضور
          </button>
          <button
            class="btn overtime"
            onclick="showInputModal('سهر')"
            aria-label="تسجيل سهر"
          >
            سهر
          </button>
          <button
            class="btn delete"
            onclick="showDeleteOptions()"
            aria-label="فتح خيارات المسح"
          >
            مسح السجل
          </button>
        </div>

        <div class="filters" aria-label="مرشحات التاريخ">
          <select
            id="yearFilter"
            onchange="filterRecords()"
            aria-label="فلتر السنة"
          >
            <option value="">كل السنوات</option>
          </select>
          <select
            id="monthFilter"
            onchange="filterRecords()"
            aria-label="فلتر الشهر"
          >
            <option value="">كل الشهور</option>
          </select>
          <select
            id="dayFilter"
            onchange="filterRecords()"
            aria-label="فلتر اليوم"
          >
            <option value="">كل الأيام</option>
          </select>
        </div>
      </div>

      <div class="history" aria-labelledby="historyTitle">
        <div class="history-header">
          <h2 id="historyTitle">سجل العمليات</h2>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table id="recordsTable" role="table" aria-describedby="historyTitle">
            <thead>
              <tr>
                <th scope="col">التاريخ</th>
                <th scope="col">نوع العملية</th>
                <th scope="col">القيمة</th>
                <th scope="col">الرصيد</th>
                <th scope="col">إجراءات</th>
              </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Input Modal -->
    <div
      class="input-modal"
      id="inputModal"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-labelledby="modalTitle"
    >
      <div class="modal-content">
        <h3 class="modal-title" id="modalTitle">إدخال القيمة</h3>
        <input
          type="number"
          class="amount-input"
          id="amountInput"
          placeholder="أدخل القيمة بالجنيه"
          min="1"
          inputmode="numeric"
          aria-label="قيمة بالجنيه"
        />
        <div class="modal-buttons">
          <button class="modal-btn cancel-btn" onclick="hideInputModal()">
            إلغاء
          </button>
          <button class="modal-btn confirm-btn" onclick="confirmAmount()">
            تأكيد
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div
      class="input-modal"
      id="deleteModal"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-labelledby="deleteTitle"
    >
      <div class="modal-content">
        <h3 class="modal-title" id="deleteTitle">خيارات مسح السجل</h3>
        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
          "
        >
          <button
            class="modal-btn"
            onclick="deleteAllRecords()"
            style="background: var(--accent-red); color: #fff"
          >
            مسح كل السجلات
          </button>
          <button
            class="modal-btn"
            onclick="deleteTodayRecords()"
            style="background: var(--accent-orange); color: #fff"
          >
            مسح سجلات اليوم
          </button>
          <button class="modal-btn cancel-btn" onclick="hideDeleteModal()">
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <script>
      // البيانات
      let records = JSON.parse(localStorage.getItem("workerRecords")) || [];
      let balance = parseInt(localStorage.getItem("workerBalance")) || 0;
      let currentAction = "";

      // عناصر
      const totalBalanceElement = document.getElementById("totalBalance");
      const recordsBody = document.getElementById("recordsBody");
      const yearFilter = document.getElementById("yearFilter");
      const monthFilter = document.getElementById("monthFilter");
      const dayFilter = document.getElementById("dayFilter");
      const inputModal = document.getElementById("inputModal");
      const deleteModal = document.getElementById("deleteModal");
      const modalTitle = document.getElementById("modalTitle");
      const amountInput = document.getElementById("amountInput");

      // تنسيق الأرقام
      const nf = new Intl.NumberFormat("ar-EG");
      function formatCurrency(n) {
        return nf.format(n) + " جنيه";
      }

      // INIT
      document.addEventListener("DOMContentLoaded", function () {
        updateBalance();
        displayRecords();
        populateFilterOptions();
      });

      // فتح المودال مع أنيميشن
      function showInputModal(action) {
        currentAction = action;
        modalTitle.textContent = `إدخال قيمة ${action}`;
        amountInput.value = "";
        inputModal.classList.add("open");
        inputModal.setAttribute("aria-hidden", "false");
        // التركيز
        setTimeout(() => amountInput.focus(), 200);
      }

      function hideInputModal() {
        inputModal.classList.remove("open");
        inputModal.setAttribute("aria-hidden", "true");
      }

      function showDeleteOptions() {
        if (records.length === 0) {
          alert("لا توجد سجلات للمسح");
          return;
        }
        deleteModal.classList.add("open");
        deleteModal.setAttribute("aria-hidden", "false");
      }

      function hideDeleteModal() {
        deleteModal.classList.remove("open");
        deleteModal.setAttribute("aria-hidden", "true");
      }

      // تأكيد إدخال القيمة
      function confirmAmount() {
        const amount = parseInt(amountInput.value);
        if (isNaN(amount) || amount <= 0) {
          alert("يرجى إدخال قيمة صحيحة");
          return;
        }
        addRecord(currentAction, amount);
        hideInputModal();
      }

      // إضافة سجل
      function addRecord(type, amount) {
        const now = new Date();
        const dateString = now.toLocaleDateString("ar-EG");
        const timeString = now.toLocaleTimeString("ar-EG");

        balance += amount;

        const record = {
          id: Date.now(),
          date: dateString,
          time: timeString,
          type: type,
          amount: amount,
          balance: balance,
          timestamp: now.getTime(),
          year: now.getFullYear(),
          month: now.getMonth() + 1,
          day: now.getDate(),
        };

        records.unshift(record);
        localStorage.setItem("workerRecords", JSON.stringify(records));
        localStorage.setItem("workerBalance", balance.toString());

        updateBalance();
        displayRecords();
        populateFilterOptions();

        alert(
          `تم تسجيل ${type} بنجاح! تم إضافة ${formatCurrency(
            amount
          )} إلى الحساب.`
        );
      }

      // حذف سجل محدد
      function deleteRecord(id) {
        if (!confirm("هل أنت متأكد من أنك تريد حذف هذا السجل؟")) return;

        const recordIndex = records.findIndex((r) => r.id === id);
        if (recordIndex === -1) return;

        records.splice(recordIndex, 1);
        updateBalancesAfterDeletion();

        localStorage.setItem("workerRecords", JSON.stringify(records));
        localStorage.setItem("workerBalance", balance.toString());

        updateBalance();
        displayRecords();
        populateFilterOptions();

        alert("تم حذف السجل بنجاح");
      }

      function updateBalancesAfterDeletion() {
        let runningBalance = 0;
        for (let r of records) {
          runningBalance += r.amount;
          r.balance = runningBalance;
        }
        balance = runningBalance;
      }

      function deleteAllRecords() {
        if (
          !confirm(
            "هل أنت متأكد من أنك تريد حذف كل السجلات؟ لا يمكن التراجع عن هذا الإجراء."
          )
        )
          return;
        records = [];
        balance = 0;
        localStorage.setItem("workerRecords", JSON.stringify(records));
        localStorage.setItem("workerBalance", balance.toString());
        updateBalance();
        displayRecords();
        populateFilterOptions();
        hideDeleteModal();
        alert("تم حذف جميع السجلات بنجاح");
      }

      function deleteTodayRecords() {
        const today = new Date();
        const d = today.getDate(),
          m = today.getMonth() + 1,
          y = today.getFullYear();
        const todayRecords = records.filter(
          (r) => r.day === d && r.month === m && r.year === y
        );
        if (todayRecords.length === 0) {
          alert("لا توجد سجلات لليوم");
          return;
        }
        if (
          !confirm(
            `هل أنت متأكد من أنك تريد حذف ${todayRecords.length} سجل لليوم؟`
          )
        )
          return;

        records = records.filter(
          (r) => !(r.day === d && r.month === m && r.year === y)
        );
        updateBalancesAfterDeletion();

        localStorage.setItem("workerRecords", JSON.stringify(records));
        localStorage.setItem("workerBalance", balance.toString());
        updateBalance();
        displayRecords();
        populateFilterOptions();
        hideDeleteModal();
        alert("تم حذف سجلات اليوم بنجاح");
      }

      function updateBalance() {
        totalBalanceElement.textContent = nf.format(balance);
      }

      // عرض السجلات - نضيف data-label لكل خلية لتتحول لكروت في الموبايل
      function displayRecords() {
        recordsBody.innerHTML = "";
        const year = yearFilter.value;
        const month = monthFilter.value;
        const day = dayFilter.value;

        const filtered = records.filter((record) => {
          return (
            (!year || record.year == year) &&
            (!month || record.month == month) &&
            (!day || record.day == day)
          );
        });

        if (filtered.length === 0) {
          recordsBody.innerHTML =
            '<tr><td colspan="5" class="no-records">لا توجد سجلات</td></tr>';
          return;
        }

        filtered.forEach((record) => {
          const row = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.setAttribute("data-label", "التاريخ");
          tdDate.innerHTML = `${record.date} - ${record.time}`;

          const tdType = document.createElement("td");
          tdType.setAttribute("data-label", "نوع العملية");
          tdType.textContent = record.type;

          const tdAmount = document.createElement("td");
          tdAmount.setAttribute("data-label", "القيمة");
          tdAmount.textContent = `+${nf.format(record.amount)} جنيه`;

          const tdBalance = document.createElement("td");
          tdBalance.setAttribute("data-label", "الرصيد");
          tdBalance.textContent = `${nf.format(record.balance)} جنيه`;

          const tdActions = document.createElement("td");
          tdActions.setAttribute("data-label", "إجراءات");
          const delBtn = document.createElement("button");
          delBtn.className = "delete-btn";
          delBtn.textContent = "حذف";
          delBtn.onclick = () => deleteRecord(record.id);
          tdActions.appendChild(delBtn);

          row.appendChild(tdDate);
          row.appendChild(tdType);
          row.appendChild(tdAmount);
          row.appendChild(tdBalance);
          row.appendChild(tdActions);

          recordsBody.appendChild(row);
        });
      }

      function populateFilterOptions() {
        // years
        const years = [...new Set(records.map((r) => r.year))].sort(
          (a, b) => b - a
        );
        const prevYear = yearFilter.value;
        yearFilter.innerHTML = '<option value="">كل السنوات</option>';
        years.forEach((y) => {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          if (String(y) === String(prevYear)) opt.selected = true;
          yearFilter.appendChild(opt);
        });

        // months (static list)
        const months = {
          1: "يناير",
          2: "فبراير",
          3: "مارس",
          4: "أبريل",
          5: "مايو",
          6: "يونيو",
          7: "يوليو",
          8: "أغسطس",
          9: "سبتمبر",
          10: "أكتوبر",
          11: "نوفمبر",
          12: "ديسمبر",
        };
        const prevMonth = monthFilter.value;
        monthFilter.innerHTML = '<option value="">كل الشهور</option>';
        for (const [v, name] of Object.entries(months)) {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = name;
          if (String(v) === String(prevMonth)) opt.selected = true;
          monthFilter.appendChild(opt);
        }

        // days
        const days = [...new Set(records.map((r) => r.day))].sort(
          (a, b) => a - b
        );
        const prevDay = dayFilter.value;
        dayFilter.innerHTML = '<option value="">كل الأيام</option>';
        days.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          if (String(d) === String(prevDay)) opt.selected = true;
          dayFilter.appendChild(opt);
        });
      }

      function filterRecords() {
        displayRecords();
      }

      // إغلاق المودال بالضغط خارج المودال أو بالـ ESC
      window.addEventListener("click", function (e) {
        if (e.target === inputModal) hideInputModal();
        if (e.target === deleteModal) hideDeleteModal();
      });
      window.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          hideInputModal();
          hideDeleteModal();
        }
      });

      // Enter داخل حقل المبلغ
      amountInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") confirmAmount();
      });
    </script>
  </body>
</html>
